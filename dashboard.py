import streamlit as st
import os
import subprocess
import time
import sys

# Set page config
st.set_page_config(page_title="Mirror App Dashboard", page_icon="ü™û", layout="wide")

# Paths
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
ENV_PATH = os.path.join(BASE_DIR, ".env")
SETUP_SQL_PATH = os.path.join(BASE_DIR, "setup.sql")

def read_env():
    env_vars = {}
    if os.path.exists(ENV_PATH):
        with open(ENV_PATH, "r") as f:
            for line in f:
                if "=" in line:
                    key, value = line.strip().split("=", 1)
                    env_vars[key] = value
    return env_vars

def write_env(env_vars):
    with open(ENV_PATH, "w") as f:
        for key, value in env_vars.items():
            f.write(f"{key}={value}\n")

def run_script(script_name):
    try:
        # Use sys.executable to ensure we use the SAME python interpreter
        # that is running this dashboard (and has the libraries installed)
        process = subprocess.Popen(
            [sys.executable, script_name],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True,
            cwd=BASE_DIR
        )
        return process
    except Exception as e:
        st.error(f"Failed to run script: {e}")
        return None

# UI Header
st.title("ü™û Mirror App Controller")
st.markdown("Sync your target website to Supabase.")

# Tabs
tab1, tab2, tab3 = st.tabs(["‚öôÔ∏è Configuration", "üöÄ Control Panel", "üìú Database Setup"])

# --- Tab 1: Configuration ---
with tab1:
    st.header("Settings")
    
    current_env = read_env()
    
    with st.form("config_form"):
        target_url = st.text_input("Target Website URL", value=current_env.get("TARGET_URL", ""))
        supabase_url = st.text_input("Supabase URL", value=current_env.get("SUPABASE_URL", ""))
        supabase_key = st.text_input("Supabase Key", value=current_env.get("SUPABASE_KEY", ""), type="password")
        ignore_patterns = st.text_input("Ignore Patterns (comma separated)", 
                                      value=current_env.get("IGNORE_PATTERNS", ""),
                                      help="Example: /baby-names, /shop, /forum")
        
        submitted = st.form_submit_button("Save Configuration")
        if submitted:
            new_env = {
                "TARGET_URL": target_url,
                "SUPABASE_URL": supabase_url,
                "SUPABASE_KEY": supabase_key,
                "IGNORE_PATTERNS": ignore_patterns
            }
            write_env(new_env)
            st.success("‚úÖ Configuration saved to .env")

# --- Tab 2: Control Panel ---
with tab2:
    st.header("Operations")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("1. Historical Sync")
        st.write("Scrape ALL existing articles.")
        if st.button("Run Bulk Sync", type="primary"):
            with st.spinner("Running bulk_sync.py..."):
                proc = run_script("bulk_sync.py")
                if proc:
                    stdout, stderr = proc.communicate()
                    # Show Stdout always if present
                    if stdout: 
                        st.code(stdout)
                    
                    # Show Stderr if present
                    if stderr:
                        st.error(stderr)
                        
                    if proc.returncode == 0:
                        st.success("Bulk Sync Completed!")
                    else:
                        st.error("Sync Failed. Check errors above.")

    with col2:
        st.subheader("2. Auto Updater")
        st.write("Start the scheduled background job.")
        if st.button("Start Auto Updater"):
            st.warning("This will run continuously in the background loop.")
            st.info("For continuous background running, please run `python auto_updater.py` in your terminal.")
            
            # Run once check demonstration
            st.write("Running a single check now...")
            proc = run_script("auto_updater.py") 
            

# --- Tab 3: Database Setup ---
with tab3:
    st.header("Database Schema")
    st.markdown("Run this SQL in your Supabase SQL Editor:")
    
    if os.path.exists(SETUP_SQL_PATH):
        with open(SETUP_SQL_PATH, "r") as f:
            sql_content = f.read()
            st.code(sql_content, language="sql")
    else:
        st.error("setup.sql not found!")

# Footer
st.divider()
st.caption("Mirror App v1.0 | generated by Antigravity")
